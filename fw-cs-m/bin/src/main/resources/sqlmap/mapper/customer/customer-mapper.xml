<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="Customer">

<select id="getCustomerList" parameterType="kr.co.fw.customer.CustomerVO" resultType="Hmap">
/* customer-mapper.xml id="getCustomerList" 모바일 고객 맵핑을 위한 기존 고객 리스트 조회 */
SELECT AA.*
  FROM (
		SELECT A.MB_ID              	/* 회사코드                     		*/
		     , A.CUST_ID                /* 고객 ID            					*/
		     , A.MO_CD                  /* 소개인사원코드          	 			*/
		     , C.EMP_NM AS MO_NM        /* 소개인사원이름          	 			*/
		     , C.SCD					/* 소개인사원소속         	 			*/
		     , A.CUST_NM                /* 고객명                      			*/
		     , A.CUST_NME               /* 영문고객명                    		*/
		     , A.PASSPORT_NUM        	/* 여권번호                  			*/
		     , A.PASSPORT_END_YMD    	/* 여권말료일                 			*/
		     , A.SSN                    /* 주민등록번호                   		*/
		     , A.GNDR_CD                /* 성별구분코드(GRP_CMM_CD = GNDR_CD) 	*/
		     , A.FOREIGN_YN             /* 외국인코드                    		*/
		     , A.EMAIL                  /* 이메일                             	*/
		     , A.CUST_CELL              /* 핸드폰번호                    		*/
		     , A.TELNO                  /* 추가연락처                    		*/
		     , A.ZIPCD                  /* 우편번호                     		*/
		     , A.ADDR1                  /* 한글주소                     		*/
		     , A.ADDR2                  /* 한글상세주소                   		*/
		     , A.ADDRE1                 /* 영문주소                     		*/
		     , A.COMPANY                /* 고객 직장명                   		*/
		     , A.ADDRE2                 /* 영문상세주소                   		*/
		     , A.BUSINESS_NUM           /* 사업자번호                    		*/
		     , A.JIKGUB                 /* 고객직급                     		*/
		     , A.JOB                    /* 고객하는일                    		*/
		     , A.COMPANY_ZIPCD          /* 고객직장주소우편번호 				*/
		     , A.COMPANY_ADDR1          /* 고객직장주소                   		*/
		     , A.COMPANY_ADDR2          /* 고객직장상세주소          			*/
		     , A.COMPANY_ADDRE1         /* 고객직장영문주소          			*/
		     , A.COMPANY_ADDRE2         /* 고객직장영문상세주소        			*/
		     , A.BANK                   /* 고객은행                     		*/
		     , A.BK_ID                  /* 고객계좌번호                   		*/
		     , A.BK_START_YMD           /* 고객계좌개설일          				*/
		     , A.CARD_NO                /* 고객카드번호                   		*/
			 , A.CARD_END_YY      		/* 고객카드유효기간(년)					*/
			 , A.CARD_END_MM      		/* 고객카드유효기간 (월)				*/
		     , A.CARD_CVS               /* 고객카드CVS코드         				*/
		     , A.TALL                   /* 고객키                             	*/
		     , A.WEIGHT                 /* 고객몸무게                    		*/
		     , A.MEMO                   /* 메모                       			*/
		     , A.IN_EMP_CD              /* 입력자 사번                   		*/
		     , A.IN_DTM                 /* 입력일자                     		*/
		     , A.UP_EMP_CD              /* 수정자 사번                   		*/
		     , A.UP_DTM                 /* 수정일자                     		*/
		     , CM1.CD_VL_NM AS GNDR_NM  /* 성별구분 							*/
  		FROM TBCS_CUSTOMER A
	  LEFT OUTER JOIN TBIN_EMPMST C
	    ON A.MB_ID = C.MB_ID
	   AND A.MO_CD = C.EMP_CD
	  LEFT OUTER JOIN (SELECT * FROM TBCM_COMMON_CODE WHERE GRP_CMM_CD = 'GNDR_CD') CM1
	    ON A.MB_ID = CM1.MB_ID
	   AND A.GNDR_CD = CM1.CD_VL
	 WHERE A.MB_ID = 'YNG' ) AA
<where>
	<if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(cust_nm)">
		AND AA.CUST_NM = #{cust_nm}
	</if>
	<if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(ssn)">
		AND AA.SSN = #{ssn}
	</if>
	<if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(cust_cell)">
		AND AA.CUST_CELL = #{cust_cell}
	</if>
	<if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(cust_id)">
		AND AA.CUST_ID = #{cust_id}
	</if>
</where>
ORDER BY AA.CUST_ID DESC
</select>

<select id="getCustomerDetail" parameterType="kr.co.fw.customer.CustomerVO" resultType="Hmap">
/* customer-mapper.xml id="getCustomerDetail" 고객 상세조회	*/
SELECT A.MB_ID              	/* 회사코드                     		*/
     , A.CUST_ID                /* 고객 ID            					*/
     , A.MO_CD                  /* 소개인사원코드          	 			*/
     , C.EMP_NM AS MO_NM        /* 소개인사원이름          	 			*/
     , A.CUST_NM                /* 고객명                      			*/
     , A.CUST_NME               /* 영문고객명                    		*/
     , A.PASSPORT_NUM        	/* 여권번호                  			*/
     , A.PASSPORT_END_YMD    	/* 여권말료일                 			*/
     , A.SSN                    /* 주민등록번호                   		*/
     , A.GNDR_CD                /* 성별구분코드(GRP_CMM_CD = GNDR_CD)   */
     , A.FOREIGN_YN             /* 외국인코드                    		*/
     , A.EMAIL                  /* 이메일                             	*/
     , A.CUST_CELL              /* 핸드폰번호                    		*/
     , A.TELNO                  /* 추가연락처                    		*/
     , A.ZIPCD                  /* 우편번호                     		*/
     , A.ADDR1                  /* 한글주소                     		*/
     , A.ADDR2                  /* 한글상세주소                   		*/
     , A.ADDRE1                 /* 영문주소                     		*/
     , A.COMPANY                /* 고객 직장명                   		*/
     , A.ADDRE2                 /* 영문상세주소                   		*/
     , A.BUSINESS_NUM           /* 사업자번호                    		*/
     , A.JIKGUB                 /* 고객직급                     		*/
     , A.JOB                    /* 고객하는일                    		*/
     , A.COMPANY_ZIPCD          /* 고객직장주소우편번호 				*/
     , A.COMPANY_ADDR1          /* 고객직장주소                   		*/
     , A.COMPANY_ADDR2          /* 고객직장상세주소          			*/
     , A.COMPANY_ADDRE1         /* 고객직장영문주소          			*/
     , A.COMPANY_ADDRE2         /* 고객직장영문상세주소        			*/
     , A.BANK                   /* 고객은행                     		*/
     , A.BK_ID                  /* 고객계좌번호                   		*/
     , A.BK_START_YMD           /* 고객계좌개설일          				*/
     , A.CARD_NO                /* 고객카드번호                   		*/
	 , A.CARD_END_YY      		/* 고객카드유효기간(년)					*/
	 , A.CARD_END_MM      		/* 고객카드유효기간 (월)				*/
     , A.CARD_CVS               /* 고객카드CVS코드         				*/
     , A.TALL                   /* 고객키                             	*/
     , A.WEIGHT                 /* 고객몸무게                    		*/
     , A.MEMO                   /* 메모                       			*/
     , A.IN_EMP_CD              /* 입력자 사번                   		*/
     , A.IN_DTM                 /* 입력일자                     		*/
     , A.UP_EMP_CD              /* 수정자 사번                   		*/
     , A.UP_DTM                 /* 수정일자                     		*/
  FROM TBCS_CUSTOMER A
  LEFT OUTER JOIN TBIN_EMPMST C
    ON A.MB_ID = C.MB_ID
   AND A.MO_CD = C.EMP_CD
  LEFT OUTER JOIN (SELECT * FROM TBCM_COMMON_CODE WHERE GRP_CMM_CD = 'GNDR_CD') CM1
    ON A.MB_ID = CM1.MB_ID
   AND A.GNDR_CD = CM1.CD_VL
 WHERE A.MB_ID = #{MB_ID}
   AND A.CUST_ID = #{CUST_ID}
</select>

<!-- 고객번호 채번 -->
<select id="selectNewNo" parameterType="kr.co.fw.customer.CustomerVO" resultType="String">
/* customer-mapper.xml id="selectNewNo" 고객 번호 채번 */
SELECT TO_CHAR(SYSDATE,'YYYYMMDD')||LPAD(NVL(MAX(SUBSTR(NVL(CUST_ID,'00000'), -5, 5)
                          ), 0) + 1, 5, '0') AS CUST_NEW_NO
  FROM TBCS_CUSTOMER
  	 WHERE TO_CHAR(IN_DTM,'YYYYMMDD')=TO_CHAR(SYSDATE,'YYYYMMDD')
</select>

<insert id="insertCustomer" parameterType="kr.co.fw.customer.CustomerVO">
<selectKey order="BEFORE" resultType="String" keyProperty="cust_id">
SELECT TO_CHAR(SYSDATE,'YYYYMMDD')||LPAD(NVL(MAX(SUBSTR(NVL(CUST_ID,'00000'), -5, 5)
                          ), 0) + 1, 5, '0') AS cust_id
  FROM TBCS_CUSTOMER
  	 WHERE TO_CHAR(IN_DTM,'YYYYMMDD')=TO_CHAR(SYSDATE,'YYYYMMDD')
</selectKey>
/* customer-mapper.xml id="insertCustomer" 고객 입력 */
INSERT
  INTO TBCS_CUSTOMER
  	 ( MB_ID              	  /* 회사코드                     		*/
     , CUST_ID                /* 고객 ID            	            */
     , MO_CD                  /* 소개인사원코드          	 	    */
     , CUST_NM                /* 고객명                      		*/
     , SSN                    /* 주민등록번호                   	*/
     , GNDR_CD                /* 성별구분코드(GRP_CMM_CD = GNDR_CD) */
     , FOREIGN_YN             /* 외국인코드                    		*/
     , CUST_CELL              /* 핸드폰번호                    		*/
     , IN_EMP_CD              /* 입력자 사번                   	    */
     , IN_DTM                 /* 입력일자                     	    */
  	 )
VALUES
	 ( 'YNG'                 	  /* 회사코드                           */
     , #{cust_id }                /* 고객 ID                  			*/
     , #{mo_cd }                  /* 소개인사원코드                     */
     , #{cust_nm }                /* 고객명                             */
     , #{ssn }                    /* 주민등록번호                       */
     , #{gndr_cd }                /* 성별구분코드(GRP_CMM_CD = GNDR_CD) */
     , #{foreign_yn }             /* 외국인코드                         */
     , #{cust_cell }              /* 핸드폰번호                         */
     , 'ADMIN'              	  /* 입력자 사번                        */
     , SYSDATE                 	  /* 입력일자                           */
	 )
</insert>

<update id="updateCustomer" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="updateCustomer" 고객 입력 */
UPDATE TBCS_CUSTOMER
   SET MB_ID      = 'YNG'               /* 회사코드                           */
     , UP_EMP_CD  = 'ADMIN'             /* 입력자 사번                        */
     , UP_DTM 	  = SYSDATE             /* 입력일자                           */
     <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(cust_id)">
     , CUST_ID    = #{cust_id }         /* 고객 ID                  		  */
     </if>
     <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(mo_cd)">
     , MO_CD      = #{mo_cd }           /* 소개인사원코드                     */
     </if>
     <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(cust_nm)">
     , CUST_NM    = #{cust_nm }         /* 고객명                             */
     </if>
     <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(ssn)">
     , SSN        = #{ssn }             /* 주민등록번호                       */
     </if>
     <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(gndr_cd)">
     , GNDR_CD    = #{gndr_cd }         /* 성별구분코드(GRP_CMM_CD = GNDR_CD) */
     </if>
     <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(foreign_yn)">
     , FOREIGN_YN = #{foreign_yn }      /* 외국인코드                         */
     </if>
     <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(cust_cell)">
     , CUST_CELL  = #{cust_cell }       /* 핸드폰번호                         */
     </if>
 WHERE CUST_ID 	  = #{cust_id}
</update>

<delete id="deleteCustomer" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteCustomer" 고객 삭제 */
DELETE
  FROM TBCS_CUSTOMER
 WHERE MB_ID = #{MB_ID}
   AND CUST_ID = #{CUST_ID}
</delete>








<insert id="customerChangeHistInsert" parameterType="kr.co.fw.customer.CustomerVO">
<selectKey order="BEFORE" resultType="String" keyProperty="SORT_NO">
SELECT NVL(MAX(SORT_NO), 0) + 1
  FROM TBCS_CHANGE_EMP_HIST
 WHERE CUST_ID = #{CUST_ID}
</selectKey>
/* customer-mapper.xml id="customerChangeHistInsert" 담당자 변경 이력 입력 */
INSERT
  INTO TBCS_CHANGE_EMP_HIST
  	 ( MB_ID          /* 회사ID VARCHAR2(10) */
	 , SORT_NO        /* 정렬번호 NUMBER(22) */
	 , CUST_ID        /* 고객ID VARCHAR2(30) */
	 , MNG_START_DTM  /* 담당 시작일자 VARCHAR2(10) */
	 <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(MNG_END_DTM)">
	 , MNG_END_DTM    /* 담당 종료일자 VARCHAR2(10) */
	 </if>
	 , MNG_EMP_CD     /* 담당자 VARCHAR2(20) */
	 , IN_EMP_CD      /* 입력자 사번 VARCHAR2(20) */
	 , IN_DTM         /* 입력일자 TIMESTAMP(6)(11) */
  	 )
VALUES
	 ( #{MB_ID}
	 , #{SORT_NO}
	 , #{CUST_ID}
	 <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(MNG_START_DTM)">
	 , #{MNG_START_DTM}
	 </if>
	 <if test="@kr.co.fw.common.util.CommUtil@isEmpty(MNG_START_DTM)">
	 , TO_CHAR(SYSDATE, 'YYYY-MM-DD')
	 </if>
	 <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(MNG_END_DTM)">
	 , #{MNG_END_DTM}
	 </if>
	 , #{MNG_EMP_CD}
	 , #{IN_EMP_CD}
	 , SYSDATE
	 )
</insert>


<delete id="deleteCustomerMepibs" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteCustomerMepibs" 고객 메핍스 삭제 */
DELETE
  FROM TBCS_CUSTOMER_ETC_INFO
 WHERE MB_ID = #{MB_ID}
   AND CUST_ID = #{CUST_ID}
</delete>

<delete id="deleteCustomerTelNum" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteCustomerTelNum" 고객 전화번호, 핸드폰번호 삭제 */
DELETE
  FROM TBCS_TELEPHONE
 WHERE MB_ID = #{MB_ID}
   AND CUST_ID = #{CUST_ID}
</delete>

<delete id="deleteCustomerRelation" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteCustomerRelation" 담당자, 영업자 삭제 */
DELETE
  FROM TBCS_CUSTOMER_RELATION
 WHERE MB_ID = #{MB_ID}
   AND CUST_ID = #{CUST_ID}
</delete>

<delete id="deleteCustomerAddr" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteCustomerAddr" 고객 주소 삭제 */
DELETE
  FROM TBCS_POST_MAIL_ADDRESS
 WHERE MB_ID = #{MB_ID}
   AND CUST_ID = #{CUST_ID}
</delete>

<delete id="deleteCustomerEmail" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteCustomerEmail" 고객 이메일 삭제 */
DELETE
  FROM TBCS_ELECTRONIC_ADDRESS
 WHERE MB_ID = #{MB_ID}
   AND CUST_ID = #{CUST_ID}
</delete>

<select id="selectChangeEmpHistList" parameterType="kr.co.fw.customer.CustomerVO" resultType="Hmap">
/* customer-mapper.xml id="selectChangeEmpHistList" 담당자 이력 변경 리스트 조회 */
SELECT A.SORT_NO       /* 정렬번호 NUMBER(22) */
	 , A.CUST_ID       /* 고객ID VARCHAR2(30) */
	 , A.MNG_START_DTM /* 담당 시작일자 VARCHAR2(10) */
	 , A.MNG_END_DTM   /* 담당 종료일자 VARCHAR2(10) */
	 , A.MNG_EMP_CD    /* 담당자 VARCHAR2(20) */
	 , EMP.EMP_NM AS MNG_EMP_NM	/* 담당자 이름 */
  FROM TBCS_CHANGE_EMP_HIST A
  LEFT OUTER JOIN TBIN_EMPMST EMP
    ON A.MB_ID = EMP.MB_ID
   AND A.MNG_EMP_CD = EMP.EMP_CD
 WHERE A.CUST_ID = #{CUST_ID}
ORDER BY SORT_NO DESC
</select>

<update id="changeCustMngEmp" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="changeCustMngEmp" 담당자 이력 등록 후 실 고객 담당자 변경 */
UPDATE TBCS_CUSTOMER_RELATION
   SET MNG_EMP_CD = #{MNG_EMP_CD}
 WHERE CUST_ID = #{CUST_ID}
   AND MB_ID = #{MB_ID}
</update>

<update id="updateChangeEmpHist" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteChangeEmpHist" 담당자 이력 수정 */
UPDATE TBCS_CHANGE_EMP_HIST
   SET MNG_START_DTM = #{MNG_START_DTM}
   	 , MNG_END_DTM = #{MNG_END_DTM}
   	 , MNG_EMP_CD = #{MNG_EMP_CD}
 WHERE MB_ID = #{MB_ID}
   AND CUST_ID = #{CUST_ID}
   AND SORT_NO = #{SORT_NO}
</update>

<delete id="deleteChangeEmpHist" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteChangeEmpHist" 담당자 이력 삭제 */
DELETE
  FROM TBCS_CHANGE_EMP_HIST
 WHERE MB_ID = #{MB_ID}
   AND CUST_ID = #{CUST_ID}
   AND SORT_NO = #{SORT_NO}
</delete>

<insert id="insertCounelingErp" parameterType="Hmap">
/* customer-mapper.xml id="deleteChangeEmpHist" 홈페이지에서 전달받은 데이터 insert */
INSERT
  INTO TBCS_COUNSELING_LIST
  	 ( MB_ID
  	 , REF_SEQ
	 , WRITEYMD
	 , CUST_NM
	 , GNDR_CD
	 , HPNO
	 , EMAIL
	 , MEPIBS_GBN
	 , FIRST_QUESTION
	 , FIRST_ANSWER
	 , SECOND_QUESTION
	 , SECOND_ANSWER
	 , THIRD_QUESTION
	 , THIRD_ANSWER
	 , REGI_CUST
	 , DATA_DCD
	 , IN_DTM
  	 )
VALUES
	 ( 'YNG'
	 , #{idx}
	 , #{writeymd}
	 , #{name}
	 , #{sex}
	 , #{phone}
	 , #{email}
	 , #{page_nm}
	 , #{first_question}
	 , #{first_answer}
	 , #{second_question}
	 , #{second_answer}
	 , #{third_question}
	 , #{third_answer}
	 , 'N'
	 , 'I'
	 , SYSDATE
	 )
</insert>

<select id="selectCounselingList" parameterType="kr.co.fw.customer.CustomerVO" resultType="Hmap">
/* customer-mapper.xml id="selectCounselingList" 상담신청 리스트 조회 */
SELECT A.MB_ID			 /* 회원사 코드 */
	 , A.REF_SEQ         /* 홈페이지의 tb_counseling 테이블의 idx 컬럼 참조 NUMBER(22) */
	 , A.WRITEYMD        /* 상담신청일자 VARCHAR2(10) */
	 , A.CUST_NM         /* 고객명 VARCHAR2(50) */
	 , A.GNDR_CD         /* 성별 VARCHAR2(10) */
	 , A.HPNO            /* 핸드폰번호 VARCHAR2(20) */
	 , A.EMAIL           /* 이메일 VARCHAR2(100) */
	 , A.MEPIBS_GBN      /* 메핍스구분 VARCHAR2(30) */
	 , A.FIRST_QUESTION  /* 첫번째 질문 VARCHAR2(500) */
	 , A.FIRST_ANSWER    /* 첫번째 질문 답 VARCHAR2(100) */
	 , A.SECOND_QUESTION /* 두번째 질문 VARCHAR2(500) */
	 , A.SECOND_ANSWER   /* 두번째 질문 답 VARCHAR2(100) */
	 , A.THIRD_QUESTION  /* 세번째 질문 VARCHAR2(500) */
	 , A.THIRD_ANSWER    /* 세번째 질문 답 VARCHAR2(100) */
	 , A.DATA_DCD        /* 데이터 구분 코드, 해당 테이블 데이터는 물리적으로 삭제하지 않고 DATA_DCD로 입력, 삭제 구분함(I : 입력, U : 수정, D : 삭제) VARCHAR2(3) */
	 , A.REGI_CUST_YN
  FROM TBCS_COUNSELING_LIST A
 WHERE A.MB_ID = #{MB_ID}
   AND A.DATA_DCD != 'D'
   AND A.WRITEYMD BETWEEN NVL(#{SRCH_START_DATE}, '1900-01-01') AND NVL(#{SRCH_END_DATE}, '9999-12-31')
  <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(SRCH_MEPIBS_GBN)">
   AND A.MEPIBS_GBN = #{SRCH_MEPIBS_GBN}
  </if>
  <if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(SRCH_CUST_NM)">
   AND A.CUST_NM LIKE CONCAT('%',#{SRCH_CUST_NM},'%')
  </if>
ORDER BY A.IN_DTM DESC
</select>

<update id="deleteCounselingMng" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteCounselingMng" 상담신청 리스트 데이터 삭제(실데이터 삭제하지 않고 DATA_DCD = D로 만듬) */
UPDATE TBCS_COUNSELING_LIST
   SET DATA_DCD = 'D'
 WHERE MB_ID = #{MB_ID}
   AND REF_SEQ = #{REF_SEQ}
</update>

<update id="updateCounselingRegiCust" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="updateCounselingRegiCust" 상담신청 리스트 데이터 고객등록여부 Y로 변경 */
UPDATE TBCS_COUNSELING_LIST
   SET REGI_CUST_YN = 'Y'
 WHERE MB_ID = #{MB_ID}
   AND REF_SEQ = #{REF_SEQ}
</update>

<select id="selectCustomerFamilyList" parameterType="kr.co.fw.customer.CustomerVO" resultType="Hmap">
/* customer-mapper.xml id="selectCustomerFamilyList" 가족사항 리스트 */
SELECT A.MB_ID           /* 회원사 코드 VARCHAR2(20) */
     , A.SORT_NO		 /* 정렬번호 NUMBER */
     , A.FAMILY_ID       /* 가족 ID VARCHAR2(30) */
     , A.REF_CUST_ID     /* 참조 고객 ID(TBCS_CUSTOMER) VARCHAR2(30) */
     , A.FAMILY_NM       /* 이름 VARCHAR2(30) */
     , A.SSN             /* 주민등록번호 VARCHAR2(110) */
     , A.RSPCD           /* 가족과의 관계 VARCHAR2(1) */
     , CM1.CD_VL_NM AS RSPCD_NM
     , A.GNDR_CD         /* 성별구분코드 VARCHAR2(1) */
     , CM2.CD_VL_NM AS GNDR_NM
     , A.REAL_BRDT       /* 생년월일 VARCHAR2(10) */
     , A.TLNO_ONE        /* 핸드폰번호 앞 3~4자리 VARCHAR2(16) */
     , A.TLNO_TWO        /* 핸드폰번호 중간 3~4자리 VARCHAR2(16) */
     , A.TLNO_THR        /* 핸드폰번호 중간 4자리 VARCHAR2(16) */
     , A.TLNO_ONE||'-'||A.TLNO_TWO||'-'||A.TLNO_THR AS HPNO
     , A.EMAIL           /* 이메일 VARCHAR2(50) */
     , A.FSB_SEQ         /* 시퀀스(TBCS_CUSTOMER_FAMILY_FSB_SEQ) NUMBER(22) */
  FROM TBCS_CUSTOMER_FAMILY A
  LEFT OUTER JOIN (SELECT * FROM TBCM_COMMON_CODE WHERE GRP_CMM_CD = 'FAMILY_RSP_CD') CM1
    ON A.MB_ID = CM1.MB_ID
   AND A.RSPCD = CM1.CD_VL
  LEFT OUTER JOIN (SELECT * FROM TBCM_COMMON_CODE WHERE GRP_CMM_CD = 'GNDR_CD') CM2
    ON A.MB_ID = CM2.MB_ID
   AND A.RSPCD = CM2.CD_VL
 WHERE A.MB_ID = #{MB_ID}
   AND A.REF_CUST_ID = #{CUST_ID}
ORDER BY SORT_NO DESC
</select>

<insert id="insertCustFamilyInfo" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="insertCustFamilyInfo" 고객 가족사항 입력 */
<selectKey keyProperty="SORT_NO" order="BEFORE" resultType="String">
SELECT NVL(MAX(SORT_NO), 0) + 1
  FROM TBCS_CUSTOMER_FAMILY
 WHERE REF_CUST_ID = #{REF_CUST_ID}
</selectKey>
INSERT
  INTO TBCS_CUSTOMER_FAMILY
  	 ( MB_ID          /* 회원사 코드 VARCHAR2(20) */
	 , SORT_NO        /* 정렬번호 NUMBER(22) */
	 , FAMILY_ID      /* 가족 ID VARCHAR2(30) */
	 , REF_CUST_ID    /* 참조 고객 ID(TBCS_CUSTOMER) VARCHAR2(30) */
	 , FAMILY_NM      /* 이름 VARCHAR2(30) */
	 , SSN            /* 주민등록번호 VARCHAR2(110) */
	 , RSPCD          /* 가족과의 관계 VARCHAR2(1) */
	 , GNDR_CD        /* 성별구분코드 VARCHAR2(1) */
	 , REAL_BRDT      /* 생년월일 VARCHAR2(10) */
	 , TLNO_ONE       /* 핸드폰번호 앞 3~4자리 VARCHAR2(16) */
	 , TLNO_TWO       /* 핸드폰번호 중간 3~4자리 VARCHAR2(16) */
	 , TLNO_THR       /* 핸드폰번호 중간 4자리 VARCHAR2(16) */
	 , EMAIL          /* 이메일 VARCHAR2(50) */
	 , IN_EMP_CD      /* 입력자 사번 VARCHAR2(20) */
	 , IN_DTM         /* 입력일자 TIMESTAMP(6)(11) */
  	 )
VALUES
	 ( #{MB_ID}
	 , #{SORT_NO}
	 , #{FAMILY_ID}
	 , #{REF_CUST_ID}
	 , #{FAMILY_NM}
	 , #{SSN}
	 , #{RSPCD}
	 , CASE
	 	   WHEN SUBSTR(#{SSN}, 8, 1) IN ('1', '3', '5') THEN 'M'
	 	   ELSE 'W'
	   END
	 , CASE
	 	   WHEN SUBSTR(#{SSN}, 8, 1) IN ('1','2','5','6') THEN TO_CHAR(TO_DATE('19'||SUBSTR(#{SSN}, 1, 6), 'YYYY-MM-DD'), 'YYYY-MM-DD')
	 	   ELSE TO_CHAR(TO_DATE('20'||SUBSTR(#{SSN}, 1, 6), 'YYYY-MM-DD'), 'YYYY-MM-DD')
	   END
	 , ''
	 , #{TLNO_ONE}
	 , #{TLNO_TWO}
	 , #{TLNO_THR}
	 , ''
	 , #{IN_EMP_CD}
	 , SYSDATE
	 )
</insert>

<update id="updateCustFamilyInfo" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="updateCustFamilyInfo" 고객 가족사항 수정 */
UPDATE TBCS_CUSTOMER_FAMILY
   SET FAMILY_NM = #{FAMILY_NM}
	 , SSN = #{SSN}
	 , RSPCD = #{RSPCD}
	 , GNDR_CD = CASE
				 	 WHEN SUBSTR(#{SSN}, 8, 1) IN ('1', '3', '5') THEN 'M'
				 	 ELSE 'W'
				 END
	 , REAL_BRDT = CASE
				 	   WHEN SUBSTR(#{SSN}, 8, 1) IN ('1','2','5','6') THEN TO_CHAR(TO_DATE('19'||SUBSTR(#{SSN}, 1, 6), 'YYYY-MM-DD'), 'YYYY-MM-DD')
				 	   ELSE TO_CHAR(TO_DATE('20'||SUBSTR(#{SSN}, 1, 6), 'YYYY-MM-DD'), 'YYYY-MM-DD')
				   END
	 , TLNO_ONE = #{TLNO_ONE}
	 , TLNO_TWO = #{TLNO_TWO}
	 , TLNO_THR = #{TLNO_THR}
	 , EMAIL = #{EMAIL}
	 , UP_EMP_CD = #{IN_EMP_CD}
	 , UP_DTM = SYSDATE
 WHERE MB_ID = #{MB_ID}
   AND REF_CUST_ID = #{REF_CUST_ID}
   AND FAMILY_ID = #{FAMILY_ID}
</update>

<delete id="deleteCustFamilyInfo" parameterType="kr.co.fw.customer.CustomerVO">
/* customer-mapper.xml id="deleteCustFamilyInfo" 고객 가족사항 삭제 */
DELETE
  FROM TBCS_CUSTOMER_FAMILY
 WHERE MB_ID = #{MB_ID}
   AND REF_CUST_ID = #{REF_CUST_ID}
   AND FAMILY_ID = #{FAMILY_ID}
</delete>

<select id="selectCustomerHoldContList" parameterType="kr.co.fw.customer.CustomerVO" resultType="bmap">
/* customer-mapper.xml id="selectCustomerHoldContList" 고객  */
SELECT A.MB_ID
     , A.CUST_ID
     , A.CUST_NM
     , CN.CONT_DATE
     , CN.INSPOL_NO
     , CN.INSCO_CD
     , INS.INSCO_NM
     , CN.PROD_SEQ
     , CN.PROD_NM
     , CN.CONT_STATUS
     , CN.GEAJA
  FROM TBCS_CUSTOMER A
 INNER JOIN TBCN_CONTRACT CN
    ON A.MB_ID = CN.MB_ID
   AND A.CUST_ID = CN.GEAJA
  LEFT JOIN TBCM_INSCO INS
    ON CN.MB_ID = INS.MB_ID
   AND CN.INSCO_CD = INS.INSCO_CD
 WHERE A.MB_ID = #{MB_ID}
<if test="@kr.co.fw.common.util.CommUtil@isNotEmpty(CUST_ID)">
   AND A.CUST_ID = #{CUST_ID}
</if>
</select>

<select id="checkDoubleUid" parameterType="kr.co.fw.customer.CustomerVO" resultType="Integer">
/* customer-mapper.xml id="checkDoubleUid" 여권번호 중복체크 */
SELECT COUNT(PASSPORT_NUM)
  FROM TBCS_CUSTOMER
 WHERE MB_ID = #{MB_ID}
 	AND PASSPORT_NUM = #{PASSPORT_NUM}
</select>

<select id="selectContractCustomer" parameterType="kr.co.fw.customer.CustomerVO" resultType="Integer">
/* customer-mapper.xml id="selectContractCustomer" 계약에 등록된 고객 확인 */
SELECT COUNT(*) 
	FROM TBCN_CONTRACT_CUSTOMER 
  WHERE MB_ID = #{MB_ID}
 	AND CUST_ID=#{CUST_ID}
</select>

	<select id="getContractListByCustomer" parameterType="kr.co.fw.customer.CustomerVO" resultType="hmap">
		SELECT A.MB_ID             /* 회원사ID                                                                       VARCHAR2(20)   */
	     , A.SEQ               /* 일련번호(TBCN_CONTRACT_SEQ)                                                    NUMBER(22)     */
	     , A.INSPOL_NO         /* 증권번호                                                                       VARCHAR2(40)   */
	     , A.IFA_CD
	     , A.INSCO_CD          /* 원수사코드                                                                     VARCHAR2(3)    */
	     , C.INSCO_NM          /* 원수사명 */
	     , C.CI_URL
	     , A.PROD_SEQ          /* 상품 일련번호                                                                  NUMBER(22)     */
	     , A.PROD_NM           /* 상품명                                                                         VARCHAR2(100)  */
	     , E.PROD_KIND1        /* 상품구분1 */
	     , A.PROD_KIND2        /* 상품구분2                                                                      VARCHAR2(20)   */
	     , A.CONT_DATE         /* 계약일자                                                                       VARCHAR2(10)   */
	     , A.CONT_STATUS       /* 계약상태(GRP_CMM_CD = CONT_STATUS)                                             VARCHAR2(4)    */
	     , A.NAPCNT            /* 납입회차                                                                        NUMBER    */
	     , A.SUGUM_STATUS      /* 수금상태                                                                       VARCHAR2(20)    */
	     , A.NAP_MONTH         /* 납입월                                                                         VARCHAR2(10)    */
	     , A.NAP_DATE          /* 납입일자                                                                       VARCHAR2(10)    */
	     , A.STATUS_DATE       /* 상태변경일                                                                      VARCHAR2(10)    */
	     , A.GIJUN_DATE        /* 데이터기준일                                                                     VARCHAR2(10)    */
	     , A.NAPMETHOD         /* 납입방법(GRP_CMM_CD = NAPMETHOD)                                               VARCHAR2(20)   */
	     , A.NAPGI             /* 납입기간                                                                       VARCHAR2(10)   */
	     , A.NAPGI_GBN         /* 납입기간구분(GRP_CMM_CD = NAPGI_GBN)                                           VARCHAR2(10)   */
	     , CM1.CD_VL_NM AS NAPGI_GBN_NM
	     , A.PREM_AMT          /* 보험료                                                                         NUMBER(22)     */
	     , A.CREDIT			   /* 크레딧                                                                         NUMBER(22)     */
	     , NVL(A.UPREM_AMT,0) AS    UPREM_AMT   
	     , NVL(A.HPREM_AMT,0) AS    HPREM_AMT   
	     , A.MON_PREM_AMT      /* 월납보험료                                                                     NUMBER(22)     */
	     , A.INSU_STRT_DATE    /* 보험시작일                                                                     VARCHAR2(10)   */
	     , A.INSU_END_DATE     /* 보험종료일                                                                     VARCHAR2(10)   */
	     , A.ACCOUNT_END_DATE  /* 초기계좌만기일                                                               VARCHAR2(10)   */
	     , A.MO_CD             /* 모집인코드                                                                     VARCHAR2(20)   */
	     , B.EMP_NM AS MO_NM   /* 모집인명 */
	     , A.YU_CD             /* 유지FP코드                                                                     VARCHAR2(20)   */
	     , F.EMP_NM AS YU_NM   /* 유지FP명 */
	     , A.ISSUE             /* 이슈사항                                                                       VARCHAR2(1000) */
	     , A.MEMO              /* 메모                                                                           VARCHAR2(4000) */
		 , A.AUTO_TRANS_YN         /* 자동이체여부(GRP_CMM_CD = AUTO_TRANS_YN) VARCHAR2(1)   */
		 , A.BANK                  /* 은행코드(GRP_CMM_CD = BANK)              VARCHAR2(50)  */
		 , A.OWNER                 /* 예금주                                   VARCHAR2(30)  */
		 , A.BK_ID                 /* 계좌번호                                 VARCHAR2(50)  */
		 , A.REGI_AUTO_TRANS_YN    /* 자동송금등록여부                         VARCHAR2(1)   */
	     , A.IN_EMP_CD         /* 입력자사번                                                                     VARCHAR2(20)   */
	     , A.IN_DTM            /* 입력일시                                                                       DATE(7)        */
	     , A.IN_IP             /* 입력 IP                                                                        VARCHAR2(15)   */
	     , A.UP_EMP_CD         /* 수정자사번                                                                     VARCHAR2(20)   */
	     , A.UP_DTM            /* 수정일시                                                                       DATE(7)        */
	     , G.CUST_ID AS GEAJA			     /* 계약자ID */
	     , G.CUST_NM AS GEAJA_NM		     /* 계약자이름 */
	     , H.CUST_ID AS PIABO			     /* 피보험자ID */
	     , H.CUST_NM AS PIABO_NM		     /* 피보험자이름 */
	     , I.CUST_ID AS BENEFICIARY		     /* 수익자ID */
	     , I.CUST_NM AS BENEFICIARY_NM	     /* 수익자이름 */
	     , A.USD_NAP_MONTH 					 /* USD 월납화 */
	     , A.HKD_NAP_MONTH 					 /* HKD 월납화 */
	  FROM TBCN_CONTRACT A /* [CN][계약] 계약관리 */
	  LEFT OUTER JOIN TBIN_EMPMST B	/* 사원(모집인)조회 */
	    ON A.MB_ID = B.MB_ID
	   AND A.MO_CD = B.EMP_CD
	  LEFT OUTER JOIN TBCM_INSCO C	/* 원수사조회 */
	    ON A.MB_ID = C.MB_ID
	   AND A.INSCO_CD = C.INSCO_CD
	  LEFT OUTER JOIN TBCN_PRODUCT_GROUP E	/* 상품군 조회 */
	    ON A.MB_ID = E.MB_ID
	   AND A.PROD_KIND2 = E.PROD_KIND2
	  LEFT OUTER JOIN TBIN_EMPMST F	/* 사원(유지FP)조회 */
	    ON A.MB_ID = F.MB_ID
	   AND A.YU_CD = F.EMP_CD
	  LEFT JOIN (SELECT CD_VL
	                  , CD_VL_NM
	               FROM TBCM_COMMON_CODE
	              WHERE MB_ID = 'YNG'
	                AND GRP_CMM_CD = 'NAPGI_GBN') CM1	/* 납기구분 공통코드 */
	    ON A.NAPGI_GBN = CM1.CD_VL
	  LEFT OUTER JOIN (  SELECT MB_ID,
	                             SEQ,
	                             GUBUN,
	                             LISTAGG (CUST_ID, ',') WITHIN GROUP (ORDER BY CUST_ID) AS CUST_ID,
	                             LISTAGG (CUST_NM, ',') WITHIN GROUP (ORDER BY CUST_ID) AS CUST_NM
	                        FROM (SELECT A.SEQ,
	                                     A.GUBUN,
	                                     A.CUST_ID,
	                                     A.MB_ID,
	                                     B.CUST_NM
	                                FROM TBCN_CONTRACT_CUSTOMER A
	                                     LEFT JOIN TBCS_CUSTOMER B
	                                        ON A.CUST_ID = B.CUST_ID AND A.MB_ID = B.MB_ID)
	                           WHERE GUBUN='GEAJA'
	                    GROUP BY SEQ, GUBUN, MB_ID) G  /* 계약자 조회 */
	    ON A.MB_ID = G.MB_ID
	   AND A.SEQ = G.SEQ
	 LEFT OUTER JOIN (  SELECT MB_ID,
	                             SEQ,
	                             GUBUN,
	                             LISTAGG (CUST_ID, ',') WITHIN GROUP (ORDER BY CUST_ID) AS CUST_ID,
	                             LISTAGG (CUST_NM, ',') WITHIN GROUP (ORDER BY CUST_ID) AS CUST_NM
	                        FROM (SELECT A.SEQ,
	                                     A.GUBUN,
	                                     A.CUST_ID,
	                                     A.MB_ID,
	                                     B.CUST_NM
	                                FROM TBCN_CONTRACT_CUSTOMER A
	                                     LEFT JOIN TBCS_CUSTOMER B
	                                        ON A.CUST_ID = B.CUST_ID AND A.MB_ID = B.MB_ID)
	                           WHERE GUBUN='PIABO'
	                    GROUP BY SEQ, GUBUN, MB_ID) H  /* 피보험자 조회 */
	    ON A.MB_ID = H.MB_ID
	   AND A.SEQ = H.SEQ   
	 LEFT OUTER JOIN (  SELECT MB_ID,
	                             SEQ,
	                             GUBUN,
	                             LISTAGG (CUST_ID, ',') WITHIN GROUP (ORDER BY CUST_ID) AS CUST_ID,
	                             LISTAGG (CUST_NM, ',') WITHIN GROUP (ORDER BY CUST_ID) AS CUST_NM
	                        FROM (SELECT A.SEQ,
	                                     A.GUBUN,
	                                     A.CUST_ID,
	                                     A.MB_ID,
	                                     B.CUST_NM
	                                FROM TBCN_CONTRACT_CUSTOMER A
	                                     LEFT JOIN TBCS_CUSTOMER B
	                                        ON A.CUST_ID = B.CUST_ID AND A.MB_ID = B.MB_ID)
	                           WHERE GUBUN='BENEFICIARY'
	                    GROUP BY SEQ, GUBUN, MB_ID) I   /* 수익자 조회 */
	    ON A.MB_ID = I.MB_ID
	   AND A.SEQ = I.SEQ     
	 WHERE A.MB_ID = 'YNG'
	   AND A.MO_CD NOT IN ('SADMIN', 'ADMIN', 'INSCOM')
	    <![CDATA[AND NVL(A.DATA_DCD,'I') <> 'D']]>

	<if test='@kr.co.fw.common.util.CommUtil@isNotEmpty(cust_id)'>
	   AND ( I.CUST_ID = #{cust_id} OR H.CUST_ID = #{cust_id} OR G.CUST_ID = #{cust_id}
		)
	</if>
	<if test='@kr.co.fw.common.util.CommUtil@isNotEmpty(cont_seq)'>
	   AND A.SEQ = #{cont_seq}
		)
	</if>

	</select>
</mapper>
